# üìã Modelagem de Ordens de Servi√ßo

## üìñ Vis√£o Geral

Este documento descreve a modelagem completa do sistema de ordens de servi√ßo, incluindo schemas, interfaces, enums e relacionamentos. Esta documenta√ß√£o serve como guia para implementa√ß√£o do backend e frontend.

## üèóÔ∏è Arquitetura do Sistema

### **M√≥dulos Principais**

- **ServiceOrder**: Ordem de servi√ßo principal
- **Invoice**: Faturas (m√≥dulo futuro)
- **Counter**: Controle de sequ√™ncia num√©rica

### **Relacionamentos**

```
ServiceOrder (1) ‚Üê‚Üí (N) Invoice
ServiceOrder (1) ‚Üê‚Üí (N) ServiceItem
Invoice (1) ‚Üê‚Üí (N) InvoiceItem
```

## üìä Schemas e Modelos

### **1. ServiceOrder (Ordem de Servi√ßo)**

#### **Campos Principais**

| Campo                  | Tipo      | Obrigat√≥rio | Descri√ß√£o                 |
| ---------------------- | --------- | ----------- | ------------------------- |
| `orderNumber`          | `number`  | ‚úÖ          | N√∫mero sequencial √∫nico   |
| `customerId`           | `string`  | ‚úÖ          | ID do cliente             |
| `equipment`            | `string`  | ‚úÖ          | Equipamento               |
| `model`                | `string`  | ‚ùå          | Modelo do equipamento     |
| `brand`                | `string`  | ‚ùå          | Marca do equipamento      |
| `serialNumber`         | `string`  | ‚ùå          | N√∫mero de s√©rie           |
| `voltage`              | `string`  | ‚ùå          | Voltagem (texto livre)    |
| `accessories`          | `string`  | ‚ùå          | Acess√≥rios (texto livre)  |
| `customerObservations` | `string`  | ‚ùå          | Observa√ß√µes do cliente    |
| `reportedDefect`       | `string`  | ‚ùå          | Defeito reclamado         |
| `warranty`             | `boolean` | ‚ùå          | Garantia (default: false) |
| `isReturn`             | `boolean` | ‚ùå          | Retorno (default: false)  |

#### **Status e Controle**

| Campo                  | Tipo                 | Obrigat√≥rio | Descri√ß√£o                      |
| ---------------------- | -------------------- | ----------- | ------------------------------ |
| `status`               | `ServiceOrderStatus` | ‚úÖ          | Status da ordem                |
| `entryDate`            | `Date`               | ‚úÖ          | Data de entrada                |
| `approvalDate`         | `Date`               | ‚ùå          | Data de aprova√ß√£o              |
| `expectedDeliveryDate` | `Date`               | ‚ùå          | Data prevista de entrega       |
| `deliveryDate`         | `Date`               | ‚ùå          | Data de entrega                |
| `deletedAt`            | `Date`               | ‚ùå          | Data de exclus√£o (soft delete) |
| `notes`                | `string`             | ‚ùå          | Notas internas                 |
| `isActive`             | `boolean`            | ‚úÖ          | Ativo (default: true)          |

#### **Financeiro**

| Campo               | Tipo              | Obrigat√≥rio | Descri√ß√£o              |
| ------------------- | ----------------- | ----------- | ---------------------- |
| `financial`         | `FinancialStatus` | ‚úÖ          | Status financeiro      |
| `paymentMethod`     | `PaymentMethod`   | ‚ùå          | Forma de pagamento     |
| `paymentConditions` | `string`          | ‚ùå          | Condi√ß√µes de pagamento |
| `servicesSum`       | `Decimal128`      | ‚úÖ          | Soma dos servi√ßos      |
| `totalDiscount`     | `Decimal128`      | ‚úÖ          | Desconto total         |
| `totalAddition`     | `Decimal128`      | ‚úÖ          | Acr√©scimo total        |
| `totalAmountPaid`   | `Decimal128`      | ‚úÖ          | Valor pago             |
| `totalAmountLeft`   | `Decimal128`      | ‚úÖ          | Valor restante         |

#### **Notas Fiscais**

| Campo             | Tipo     | Obrigat√≥rio | Descri√ß√£o               |
| ----------------- | -------- | ----------- | ----------------------- |
| `serviceInvoice`  | `string` | ‚ùå          | Nota fiscal de servi√ßos |
| `saleInvoice`     | `string` | ‚ùå          | Nota fiscal de venda    |
| `shippingInvoice` | `string` | ‚ùå          | Nota fiscal de remessa  |

#### **Integra√ß√£o com Faturas (Futuro)**

| Campo              | Tipo          | Obrigat√≥rio | Descri√ß√£o               |
| ------------------ | ------------- | ----------- | ----------------------- |
| `invoiceId`        | `string`      | ‚ùå          | ID da fatura principal  |
| `invoiceItemIds`   | `string[]`    | ‚ùå          | IDs dos itens de fatura |
| `paymentType`      | `PaymentType` | ‚úÖ          | Tipo de pagamento       |
| `installmentCount` | `number`      | ‚úÖ          | N√∫mero de parcelas      |
| `paidInstallments` | `number`      | ‚úÖ          | Parcelas pagas          |

### **2. ServiceItem (Servi√ßo Executado)**

#### **Campos**

| Campo         | Tipo         | Obrigat√≥rio | Descri√ß√£o            |
| ------------- | ------------ | ----------- | -------------------- |
| `description` | `string`     | ‚úÖ          | Descri√ß√£o do servi√ßo |
| `quantity`    | `number`     | ‚úÖ          | Quantidade (min: 1)  |
| `value`       | `Decimal128` | ‚úÖ          | Valor unit√°rio       |
| `discount`    | `Decimal128` | ‚ùå          | Desconto             |
| `addition`    | `Decimal128` | ‚ùå          | Acr√©scimo            |
| `total`       | `Decimal128` | ‚ùå          | Total (calculado)    |

### **3. Invoice (Fatura - Futuro)**

#### **Campos Principais**

| Campo             | Tipo            | Obrigat√≥rio | Descri√ß√£o              |
| ----------------- | --------------- | ----------- | ---------------------- |
| `invoiceNumber`   | `string`        | ‚úÖ          | N√∫mero da fatura       |
| `serviceOrderId`  | `string`        | ‚úÖ          | ID da ordem de servi√ßo |
| `customerId`      | `string`        | ‚úÖ          | ID do cliente          |
| `totalAmount`     | `Decimal128`    | ‚úÖ          | Valor total            |
| `status`          | `InvoiceStatus` | ‚úÖ          | Status da fatura       |
| `issueDate`       | `Date`          | ‚úÖ          | Data de emiss√£o        |
| `dueDate`         | `Date`          | ‚ùå          | Data de vencimento     |
| `paidAmount`      | `Decimal128`    | ‚úÖ          | Valor pago             |
| `remainingAmount` | `Decimal128`    | ‚úÖ          | Valor restante         |

### **4. InvoiceItem (Item da Fatura - Futuro)**

#### **Campos**

| Campo               | Tipo                | Obrigat√≥rio | Descri√ß√£o              |
| ------------------- | ------------------- | ----------- | ---------------------- |
| `serviceOrderId`    | `string`            | ‚úÖ          | ID da ordem de servi√ßo |
| `description`       | `string`            | ‚úÖ          | Descri√ß√£o              |
| `amount`            | `Decimal128`        | ‚úÖ          | Valor da parcela       |
| `dueDate`           | `Date`              | ‚úÖ          | Data de vencimento     |
| `installmentNumber` | `number`            | ‚úÖ          | N√∫mero da parcela      |
| `status`            | `InvoiceItemStatus` | ‚úÖ          | Status da parcela      |
| `paidAmount`        | `Decimal128`        | ‚úÖ          | Valor pago             |

### **5. Counter (Contador de Sequ√™ncia)**

#### **Campos**

| Campo            | Tipo     | Obrigat√≥rio | Descri√ß√£o          |
| ---------------- | -------- | ----------- | ------------------ |
| `sequence_value` | `number` | ‚úÖ          | Valor da sequ√™ncia |

## üî¢ Enums

### **ServiceOrderStatus**

```typescript
enum ServiceOrderStatus {
  CONFIRMAR = 'confirmar', // Aguardando confirma√ß√£o
  APROVADO = 'aprovado', // Aprovado para execu√ß√£o
  PRONTO = 'pronto', // Pronto para entrega
  ENTREGUE = 'entregue', // Entregue ao cliente
  REPROVADO = 'reprovado', // Reprovado
}
```

### **FinancialStatus**

```typescript
enum FinancialStatus {
  EM_ABERTO = 'em_aberto', // Em aberto
  PAGO = 'pago', // Totalmente pago
  PARCIALMENTE_PAGO = 'parcialmente_pago', // Parcialmente pago
  DEVE = 'deve', // Deve
  FATURADO = 'faturado', // Faturado
  VENCIDO = 'vencido', // Vencido
  CANCELADO = 'cancelado', // Cancelado
}
```

### **PaymentMethod**

```typescript
enum PaymentMethod {
  DEBITO = 'd√©bito', // D√©bito
  CREDITO = 'credito', // Cr√©dito
  DINHEIRO = 'dinheiro', // Dinheiro
  PIX = 'pix', // PIX
  BOLETO = 'boleto', // Boleto
}
```

### **PaymentType**

```typescript
enum PaymentType {
  CASH = 'CASH', // √Ä vista
  INSTALLMENT = 'INSTALLMENT', // Parcelado
  PENDING = 'PENDING', // Pendente
}
```

### **InvoiceStatus (Futuro)**

```typescript
enum InvoiceStatus {
  PENDING = 'PENDING', // Pendente
  PARTIAL = 'PARTIAL', // Parcial
  PAID = 'PAID', // Pago
  OVERDUE = 'OVERDUE', // Vencido
  CANCELLED = 'CANCELLED', // Cancelado
}
```

### **InvoiceItemStatus (Futuro)**

```typescript
enum InvoiceItemStatus {
  PENDING = 'PENDING', // Pendente
  PAID = 'PAID', // Pago
  OVERDUE = 'OVERDUE', // Vencido
}
```

## üîó Interfaces TypeScript

### **IServiceOrder**

```typescript
interface IServiceOrder {
  id: string;
  orderNumber: number;
  customerId: string;
  equipment: string;
  model?: string;
  brand?: string;
  serialNumber?: string;
  voltage?: string;
  accessories?: string;
  customerObservations?: string;
  reportedDefect?: string;
  warranty?: boolean;
  isReturn?: boolean;
  status: ServiceOrderStatus;
  entryDate: Date;
  approvalDate?: Date;
  expectedDeliveryDate?: Date;
  deliveryDate?: Date;
  deletedAt?: Date;
  notes?: string;
  financial: FinancialStatus;
  paymentMethod?: PaymentMethod;
  paymentConditions?: string;
  serviceInvoice?: string;
  saleInvoice?: string;
  shippingInvoice?: string;
  services: IServiceItem[];
  servicesSum: Types.Decimal128;
  totalDiscount: Types.Decimal128;
  totalAddition: Types.Decimal128;
  totalAmountPaid: Types.Decimal128;
  totalAmountLeft: Types.Decimal128;
  // Campos de integra√ß√£o
  invoiceId?: string;
  invoiceItemIds?: string[];
  paymentType: PaymentType;
  installmentCount: number;
  paidInstallments: number;
  isActive: boolean;
  createdAt?: Date;
  updatedAt?: Date;
}
```

### **IServiceItem**

```typescript
interface IServiceItem {
  description: string;
  quantity: number;
  value: Types.Decimal128;
  discount: Types.Decimal128;
  addition: Types.Decimal128;
  total: Types.Decimal128;
}
```

### **ICreateServiceOrder**

```typescript
interface ICreateServiceOrder {
  customerId: string;
  equipment: string;
  model?: string;
  brand?: string;
  serialNumber?: string;
  voltage?: string;
  accessories?: string;
  customerObservations?: string;
  warranty?: boolean;
  isReturn?: boolean;
  expectedDeliveryDate?: Date;
  notes?: string;
  paymentMethod?: PaymentMethod;
  paymentConditions?: string;
  services?: IServiceItem[];
  totalDiscount?: Types.Decimal128;
  totalAddition?: Types.Decimal128;
  // Campos de integra√ß√£o
  invoiceId?: string;
  invoiceItemIds?: string[];
  paymentType?: PaymentType;
  installmentCount?: number;
  paidInstallments?: number;
}
```

### **IUpdateServiceOrder**

```typescript
interface IUpdateServiceOrder {
  equipment?: string;
  model?: string;
  brand?: string;
  serialNumber?: string;
  voltage?: string;
  accessories?: string;
  customerObservations?: string;
  warranty?: boolean;
  isReturn?: boolean;
  status?: ServiceOrderStatus;
  approvalDate?: Date;
  expectedDeliveryDate?: Date;
  deliveryDate?: Date;
  notes?: string;
  financial?: FinancialStatus;
  paymentMethod?: PaymentMethod;
  paymentConditions?: string;
  serviceInvoice?: string;
  saleInvoice?: string;
  shippingInvoice?: string;
  services?: IServiceItem[];
  totalDiscount?: Types.Decimal128;
  totalAddition?: Types.Decimal128;
  totalAmountPaid?: Types.Decimal128;
  totalAmountLeft?: Types.Decimal128;
  // Campos de integra√ß√£o
  invoiceId?: string;
  invoiceItemIds?: string[];
  paymentType?: PaymentType;
  installmentCount?: number;
  paidInstallments?: number;
}
```

## üìà Fluxo de Status

### **Status da Ordem de Servi√ßo**

```
CONFIRMAR ‚Üí APROVADO ‚Üí PRONTO ‚Üí ENTREGUE
    ‚Üì
REPROVADO
```

### **Status Financeiro**

```
EM_ABERTO ‚Üí FATURADO ‚Üí PARCIALMENTE_PAGO ‚Üí PAGO
    ‚Üì
VENCIDO
    ‚Üì
CANCELADO
```

## üí∞ C√°lculos Financeiros

### **ServiceItem Total**

```typescript
total = value * quantity + addition - discount;
```

### **ServiceOrder Totals**

```typescript
servicesSum = sum(serviceItem.total);
totalAmount = servicesSum + totalAddition - totalDiscount;
totalAmountLeft = totalAmount - totalAmountPaid;
```

## üîç √çndices de Performance

### **ServiceOrder**

```typescript
// √çndices principais
{ orderNumber: 1 } // √önico
{ customerId: 1 }
{ status: 1 }
{ entryDate: -1 }
{ isActive: 1, deletedAt: 1 }
{ financial: 1 }
{ serialNumber: 1 }
{ createdAt: -1 }
```

## üöÄ Endpoints Sugeridos

### **CRUD B√°sico**

```
GET    /service-orders           # Listar ordens
POST   /service-orders           # Criar ordem
GET    /service-orders/:id       # Buscar por ID
PUT    /service-orders/:id       # Atualizar ordem
DELETE /service-orders/:id       # Excluir ordem (soft delete)
```

### **Busca Espec√≠fica**

```
GET    /service-orders/number/:orderNumber  # Buscar por n√∫mero
GET    /service-orders/customer/:customerId # Buscar por cliente
GET    /service-orders/status/:status       # Buscar por status
GET    /service-orders/financial/:financial # Buscar por status financeiro
```

### **Integra√ß√£o com Faturas (Futuro)**

```
POST   /service-orders/with-installments    # Criar com parcelas
PUT    /service-orders/:id/payment          # Atualizar pagamento
GET    /service-orders/:id/invoices         # Buscar faturas
```

## üé® Guia para Frontend

### **Formul√°rio de Cria√ß√£o**

```typescript
interface CreateServiceOrderForm {
  // Dados do cliente
  customerId: string;

  // Dados do equipamento
  equipment: string;
  model?: string;
  brand?: string;
  serialNumber?: string;
  voltage?: string;
  accessories?: string;

  // Observa√ß√µes
  customerObservations?: string;
  reportedDefect?: string;
  notes?: string;

  // Configura√ß√µes
  warranty: boolean;
  isReturn: boolean;
  expectedDeliveryDate?: Date;

  // Financeiro
  paymentMethod?: PaymentMethod;
  paymentConditions?: string;
  totalDiscount?: number;
  totalAddition?: number;

  // Servi√ßos
  services: ServiceItemForm[];
}

interface ServiceItemForm {
  description: string;
  quantity: number;
  value: number;
  discount?: number;
  addition?: number;
}
```

### **Formul√°rio de Atualiza√ß√£o**

```typescript
interface UpdateServiceOrderForm {
  // Dados do equipamento
  equipment?: string;
  model?: string;
  brand?: string;
  serialNumber?: string;
  voltage?: string;
  accessories?: string;

  // Observa√ß√µes
  customerObservations?: string;
  reportedDefect?: string;
  notes?: string;

  // Status
  status?: ServiceOrderStatus;
  approvalDate?: Date;
  expectedDeliveryDate?: Date;
  deliveryDate?: Date;

  // Financeiro
  financial?: FinancialStatus;
  paymentMethod?: PaymentMethod;
  paymentConditions?: string;
  totalDiscount?: number;
  totalAddition?: number;
  totalAmountPaid?: number;

  // Servi√ßos
  services?: ServiceItemForm[];
}
```

### **Componentes Sugeridos**

- **ServiceOrderList**: Lista de ordens com filtros
- **ServiceOrderForm**: Formul√°rio de cria√ß√£o/edi√ß√£o
- **ServiceOrderDetails**: Detalhes da ordem
- **ServiceItemList**: Lista de servi√ßos
- **ServiceItemForm**: Formul√°rio de servi√ßo
- **FinancialStatus**: Status financeiro
- **PaymentInfo**: Informa√ß√µes de pagamento

### **Estados da Interface**

```typescript
interface ServiceOrderState {
  orders: IServiceOrder[];
  currentOrder: IServiceOrder | null;
  loading: boolean;
  error: string | null;
  filters: {
    status?: ServiceOrderStatus;
    financial?: FinancialStatus;
    customerId?: string;
    dateRange?: { start: Date; end: Date };
  };
  pagination: {
    page: number;
    limit: number;
    total: number;
  };
}
```

## üîß Valida√ß√µes de Neg√≥cio

### **ServiceOrder**

- `orderNumber` deve ser √∫nico
- `customerId` deve existir
- `equipment` √© obrigat√≥rio
- `entryDate` √© obrigat√≥rio
- `approvalDate` s√≥ pode ser preenchida se `status = 'aprovado'`
- `deliveryDate` s√≥ pode ser preenchida se `status = 'entregue'`

### **ServiceItem**

- `description` √© obrigat√≥rio
- `quantity` deve ser >= 1
- `value` deve ser >= 0
- `discount` deve ser >= 0
- `addition` deve ser >= 0
- `total` √© calculado automaticamente

### **Financeiro**

- `totalAmountPaid` + `totalAmountLeft` = `totalAmount`
- `paidInstallments` <= `installmentCount`
- `totalAmountLeft` >= 0

## üìä Relat√≥rios Sugeridos

### **Relat√≥rios de Ordem**

- Ordens por per√≠odo
- Ordens por status
- Ordens por cliente
- Performance de entrega

### **Relat√≥rios Financeiros**

- Faturamento por per√≠odo
- Status de pagamento
- Inadimpl√™ncia
- Recebimentos

### **Relat√≥rios de Equipamento**

- Equipamentos mais atendidos
- Problemas recorrentes
- Tempo m√©dio de reparo

## üöÄ Pr√≥ximos Passos

1. **Implementar m√≥dulo de ordens de servi√ßo**
2. **Criar m√≥dulo de faturas**
3. **Implementar integra√ß√£o entre m√≥dulos**
4. **Adicionar relat√≥rios**
5. **Criar dashboard**
6. **Implementar notifica√ß√µes**
7. **Adicionar auditoria**

---

**üìù Nota**: Esta documenta√ß√£o √© um guia completo para implementa√ß√£o. Mantenha-a atualizada conforme o sistema evolui.
